\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{geometry}
\usepackage{hyperref}
\usepackage{amsmath,amssymb}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{ifthen}
\usepackage{tabularx}

% ---------------------------------------------------------------------------
% Title
% ---------------------------------------------------------------------------
\title{Secret Raffle: A Privacy Preserving Lottery dApp on Secret Network}
\author{Henry J. Borthwick}

\begin{document}

\maketitle

% ---------------------------------------------------------------------------
% Abstract
% ---------------------------------------------------------------------------
\begin{abstract}
  
\end{abstract}

% ---------------------------------------------------------------------------
% Problem Statement & Motivation 1/2 page
% ---------------------------------------------------------------------------
\section{Problem Statement \& Motivation}
\subsection{Problem Statement}
\textbf{Centralised Raffles: A Broken Trust Model:} Raffles are almost always operated on a central authority model where we rely upon a central actor for raffle integrity. Raffle integrity being that there is no 'rigging of the draw' or any deviation from allowing users to buy tickets, have a truly random ticket drawn and the winner receive the prize. Further more, even with raffles moved to on chain systems, they expose a major weakness: every purchase is publicly traceable and winner selection typically relies on external random-number services or opaque scripts. \textbf{The need for verifiable and private lotteries:} Raffles need a way to raise funds or distribute rewards in a manner that is both provably fair \emph{and} respectful of participants' privacy. A transparent contract is essential for auditability, yet publishing every wallet's ticket balance can comprise user privacy or raffle integrity. Likewise, sourcing randomness must not introduce new trust assumptions or central points of failure.

\subsection{Motivation}
\textbf{Why Secret Network + CosmWasm:} Secret Network brings encrypted contract state and compute to the Cosmos ecosystem. By storing ticket counts and the raffle's secret phrase inside the Trusted Execution Environment (TEE), our \emph{Secret Raffle} contract delivers: (1) \emph{Privacy:} Individual ticket balances are hidden except from the rightful owner, revealed only through permissioned queries (\texttt{Permit}) after wallet signature. (2) \emph{Trustless Funds Escrow:} All payments are held by the contract with payout executed when the winner is selected and they claim their prize at their discretion. (3) \emph{On-chain randomness:} derives a pseudo-random seed from Secret Network's encrypted block entropy, eliminating reliance on untrusted opaque or third-party services. (4) \emph{Role based access control:} Only the admin can configure and start the raffle, while any user may purchase tickets; only the selected winner can claim the pot. These properties address both fairness and privacy gaps in existing lottery raffle systems, providing a trustless and pseudo-anonymous service.

% ---------------------------------------------------------------------------
% Related Work & Context 1/2 page
% ---------------------------------------------------------------------------
\section{Related Work \& Context}
\subsection{Context}
Blockchain lotteries aim to offer fair and transparent prize distribution, but existing solutions compromise either privacy or trust. Public ledgers expose user activity, while privacy-focused designs often rely on off-chain randomness or trusted parties, reducing verifiability. \emph{Secret Raffle} addresses these gaps by combining (1) \emph{Encrypted state:} for confidential ticket balances. (2) \emph{Enclave-derived randomness:} to eliminate oracle dependence. (3) \emph{Self-contained winner selection and payout:} within a single CosmWasm contract. (4) \emph{Standardised permit queries:} for private winner verification.

\subsection{Related Work}
\textbf{(1) PoolTogether (Ethereum):} A ``no-loss'' lottery pooling deposits into interest-bearing protocols, with winners selected via Chainlink VRF. It ensures transparency but exposes transactions publicly and depends on a trusted oracle~\cite{PoolTogether}. \textbf{(2) PancakeSwap Lottery (BNB Smart Chain):} Users buy tickets with CAKE tokens, and winners are chosen again using Chainlink VRF. Ticket counts are visible, enabling behavior analysis and strategic exploitation~\cite{PancakeSwap}. \textbf{(3) Lucky45 (Cosmos/L2):} Lucky45 is a 2025 modular on-chain protocol that begins with a decentralized lottery leveraging on-chain verifiable randomness, expanding into a suite of luck-based games.~\cite{Lucky45}.

% ---------------------------------------------------------------------------
% Defining the Architecture & Contract Design section
% ---------------------------------------------------------------------------
\section{Architecture \& Contract Design}

\subsection{Architecture}
Figure \ref{fig:Frontend Contract Interaction Architecture Structure Diagram Appendix} shows the frontend-contract modules interaction architecture structure diagram for the secret raffle dApp. It shows the direction of interaction flow, highlighting module boundaries and hand off points between off chain and on chain logic between the React UI, CosmWasm contract and Secret Testnet.

\subsection{Contract Design}

Tables \ref{tab:ExecuteMsg Schema}, \ref{tab:QueryMsg Schema}, and \ref{tab:State Layout} define the contract's external interface and its private state. Table~\ref{tab:ExecuteMsg Schema} lists the \emph{ExecuteMsg} variants, the transaction messages that mutate state with required parameters, who is authorised to send them, and what they do. Table~\ref{tab:QueryMsg Schema} describes the read only \emph{QueryMsg} variants, showing data retrieved either publicly or with a permit. The final table, \ref{tab:State Layout}, itemises every persistent storage key inside the enclave. Table \ref{tab:Security Considerations} identifies the security features implemented for the application to prevent unauthorised access, pathological edge cases, randomness manipulation, and privacy leakage. Table \ref{tab:Special Features} shows the features enabled by Secret Network's private compute encrypted state, permit gated queries, and upgrade hooks such as the time-lock pattern.

% ---------------------------------------------------------------------------
% Frontend Workflow & UX 1/4 page
% ---------------------------------------------------------------------------
\section{Frontend Workflow \& UX}
The user and admin frontend interaction workflow and user experience is represented using a flow diagram in Figure \ref{fig:Frontend Workflow Appendix} showing the touch points of a user, admin and prize winner through the entire raffle process from raffle configuration to prize redemption. The figure also double as a UX contract showing what is exposed at each state.

% ---------------------------------------------------------------------------
% Implementation Choices & Tradeoffs 1/4 page
% ---------------------------------------------------------------------------
\section{Implementation Choices \& Tradeoffs}

\textbf{(1) Flag based lifecycle tracking:} Instead of a single enum that serialises the raffle's current stage, the contract stores three independent boolean flags (\texttt{RAFFLE\_STARTED}, \texttt{WINNER\_SELECTED}, \texttt{PRIZE\_CLAIMED}). This requires one extra storage slot, but it simplifies future upgrades because adding a new phase is a non breaking change. However, this does take extra storage space and read cost. The trade off is forward compatibility over byte efficiency. \textbf{(2) On chain randomness via env.block.random:} Winner is picked by hashing the encrypted block seed and modding by \texttt{TOTAL\_TICKETS}. This removes dependency on external VRF oracles (lower latency, no additional fees), but with the cost of a small modulo bias. Because the maximum prize in the demo is intentionally small (\(<10~SCRT)\) and we judged the attack surface acceptable given that there would be a future upgrade path to integrate Secret Network's dedicated Randomness API for higher guarantees. \textbf{(3) Permit-Based Private Queries:} Reads (\texttt{get\_tickets}, \texttt{get\_secret}) require a SNIP-24 \emph{permit} included in the query payload. This keeps balances private while avoiding the UX friction of persistent viewing keys. The trade off is a larger query payload and one extra Keplr pop up, but the privacy trade off is acceptable given it does not prevent any critical user experience of the raffle.

% ---------------------------------------------------------------------------
% Future Work & Roadmap 1/4 page
% ---------------------------------------------------------------------------
\section{Future Work \& Roadmap}

\textbf{(1) v1.1 – Security \& Reliability:} Goal of this upgrade is to enhance raffle fairness and security. Replace the demo modulo selection with Secret Network's VRF Randomness API to stop modulo bias and proposer grinding risk. Overall it will ensure cryptographically secure, unbiased winner selection increasing trust in the secret raffle system and promote greater stakes raffles. \textbf{(2) v1.2 – Tokenisation \& Marketplace:} Goal is to introduce tradeable raffle tickets. Add SNIP-20 "RAFFLE" Ticket Tokens so we can mint tradable tickets. This would enable a secondary market for transfers and on chain proof of ownership. We would adopt a multi contract architecture to separate ticket and raffle logic into their own contracts. The raffle contract could read balances via cross contract queries. The impact is to allow for greater user freedoms through ticket trading, gas efficiency and greater separation of concerns for maintenance.

% ---------------------------------------------------------------------------
% References & Citations
% ---------------------------------------------------------------------------
\section{References \& Citations}
\begin{thebibliography}{9}

\bibitem{PoolTogether}
PoolTogether. ``A no-loss lottery built on Ethereum.'' Available: \url{https://www.pooltogether.com/}

\bibitem{PancakeSwap}
PancakeSwap. ``Lottery.'' Documentation. Available: \url{https://docs.pancakeswap.finance/products/lottery}
\end{thebibliography}

\newpage

% ---------------------------------------------------------------------------
% Appendix
% ---------------------------------------------------------------------------
\section{Appendix}

\subsection{Frontend Contract Interaction Architecture Structure Diagram}
\begin{figure}[h]
  \vspace{-0.5cm}
  \hspace{-2cm}
  \includegraphics[width=1.3\textwidth]{Secret Raffle Monorepo Frontend Contract Interaction Diagram.png}
  \caption{Frontend Contract Interaction Architecture Structure Diagram.}
  \label{fig:Frontend Contract Interaction Architecture Structure Diagram Appendix}
\end{figure}

\newpage

\subsection{Frontend \& UX Workflow Diagram}
\begin{figure}[h]
  \vspace{0cm}
  \hspace{0cm}
  \includegraphics[width=0.6\textwidth]{frontend-workflow.png}
  \caption{Frontend \& UX Workflow Diagram.}
  \label{fig:Frontend Workflow Appendix}
\end{figure}

\newpage

% ExecuteMsg Schema table
\begin{table}[h]
  \centering
  \caption{ExecuteMsg Schema}
  \label{tab:ExecuteMsg Schema}
  \begin{tabular}{@{}llll@{}}
    \toprule
    \textbf{Variant} & \textbf{Fields} & \textbf{Access} & \textbf{Purpose} \\
    \midrule
    \texttt{set\_raffle} & \texttt{ticket\_price}, \texttt{end\_time}, \texttt{secret} & Admin & Configure raffle parameters. \\
    \midrule
    \texttt{start\_raffle} & -- & Admin & Open raffle for ticket purchases. \\
    \midrule
    \texttt{buy\_ticket} & (requires attached \texttt{uSCRT}) & Public & Purchase one or more tickets. \\
    \midrule
    \texttt{select\_winner} & -- & Admin & Pick winner after \texttt{end\_time}. \\
    \midrule
    \texttt{claim\_prize} & -- & Winner & Claim the pot and reveal secret. \\
    \bottomrule
  \end{tabular}
\end{table}

% QueryMsg Schema table
\begin{table}[h]
  \centering
  \caption{QueryMsg Schema}
  \label{tab:QueryMsg Schema}
  \begin{tabular}{@{}llll@{}}
    \toprule
    \textbf{Variant} & \textbf{Fields} & \textbf{Access} & \textbf{Purpose} \\
    \midrule
    \texttt{raffle\_info} & -- & Public & Raffle summary \\
    \midrule
    \texttt{with\_permit} $\rightarrow$ \texttt{get\_secret} & \texttt{Permit} & Winner & Reveal secret phrase \\
    \midrule
    \texttt{with\_permit} $\rightarrow$ \texttt{get\_tickets} & \texttt{Permit} & Ticket holder & View own ticket count \\
    \bottomrule
  \end{tabular}
\end{table}

% State Layout table
\begin{table}[h]
  \centering
  \caption{State Layout}
  \label{tab:State Layout}
  \begin{tabular}{@{}lll@{}}
    \toprule
    \textbf{Key} & \textbf{Type} & \textbf{Purpose} \\
    \midrule
    \texttt{ADMIN} & \texttt{Item<CanonicalAddr>} & Contract admin \\
    \texttt{RAFFLE} & \texttt{Item<Rfle>} & Config: end time, price, secret \\
    \texttt{TICKETS} & \texttt{Keymap<CanonicalAddr,u64>} & User ticket balances \\
    \texttt{TOTAL\_TICKETS} & \texttt{Item<u64>} & Total tickets sold \\
    \texttt{WINNER} & \texttt{Item<Option<CanonicalAddr>>} & Selected winner \\
    \texttt{RAFFLE\_STARTED} & \texttt{Item<bool>} & Raffle status \\
    \texttt{WINNER\_SELECTED} & \texttt{Item<bool>} & Winner selection status \\
    \texttt{PRIZE\_CLAIMED} & \texttt{Item<bool>} & Prize claim status \\
    \bottomrule
\end{tabular}
\end{table}

\newpage

% Security Considerations table
\begin{table}[h]
  \centering
  \caption{Security Considerations}
  \label{tab:Security Considerations}
  \begin{tabular}{@{}lp{10cm}@{}}
    \toprule
    \textbf{Aspect} & \textbf{Design Notes} \\
    \midrule
    Access Control & Admin-only actions restricted; UI conceals options for non-admins. \\
    \midrule
    Edge Cases & Zero-ticket scenarios handled without errors. \\
    \midrule
    Randomness & Block entropy used for demo; upgradable to Secret Randomness API. \\
    \midrule
    Privacy & Encrypted state with permit-only access. \\
    \bottomrule
  \end{tabular}
\end{table}

% Special Features table
\begin{table}[h]
  \centering
  \caption{Special Features}
  \label{tab:Special Features}
  \begin{tabularx}{\textwidth}{@{}lX@{}}
    \toprule
    \textbf{Feature} & \textbf{Description} \\
    \midrule
    Encrypted State & Ticket counts and the hidden secret phrase are stored inside the enclave, never appearing on the public ledger. \\
    \midrule
    On-chain Randomness (Stretch Goal) & Winner selection draws entropy from the encrypted block seed, showcasing a fully on-chain random draw without external VRF services. \\
    \midrule
    Timelock Pattern (Stretch Goal) & Privileged actions such as \texttt{select\_winner} are gated by an \texttt{end\_time} timestamp. \\
    \midrule
    Other Smart Contract Dev Feature (Stretch Goal) & Permit-Based Queries access to private data requires a wallet-signed \texttt{Permit}, ensuring only authorised users can view their tickets or the secret. \\
    \bottomrule
  \end{tabularx}
\end{table}

\newpage

% \subsection{dApp Contract, Uploader, and Frontend Interaction Architecture Structure Diagram}
% \begin{figure}[h]
%   \vspace{-0.5cm}
%   \hspace{-3cm}
%   \includegraphics[width=1.4\textwidth]{Secret Raffle Monorepo Structure Diagram.png}
%   \caption{dApp Contract, Uploader, and Frontend Architecture Interaction Structure Diagram.}
%   \label{fig:dApp Contract, Uploader, and Frontend Architecture Interaction Structure Diagram Appendix}
% \end{figure}

% \subsection{dApp Contract, Uploader, and Frontend Architecture Structure Diagram}
% \begin{figure}[h]
%   \vspace{0cm}
%   \hspace{-3cm}
%   \includegraphics[width=1.4\textwidth]{Secret Raffle Monorepo Structure Diagram v2.png}
%   \caption{dApp Contract, Uploader, and Frontend Architecture Structure Diagram.}
%   \label{fig:dApp Contract, Uploader, and Frontend Architecture Structure Diagram Appendix}
% \end{figure}

% \newpage

% \subsection{Contract Architecture Structure Diagram}
% \begin{figure}[h]
%   \vspace{0cm}
%   \hspace{-3cm}
%   \includegraphics[width=1.4\textwidth]{Secret Raffle Monorepo Contract Structure Diagram.png}
%   \caption{Contract Architecture Structure Diagram.}
%   \label{fig:Contract Architecture Structure Diagram Appendix}
% \end{figure}

% \subsection{Uploader Architecture Structure Diagram}
% \begin{figure}[h]
%   \vspace{0cm}
%   \hspace{-3cm}
%   \includegraphics[width=1.4\textwidth]{Secret Raffle Monorepo Uploader Structure Diagram.png}
%   \caption{Uploader Architecture Structure Diagram.}
%   \label{fig:Uploader Architecture Structure Diagram Appendix}
% \end{figure}

% \newpage

% \subsection{Frontend Architecture Structure Diagram}
% \begin{figure}[h]
%   \vspace{0cm}
%   \hspace{-3cm}
%   \includegraphics[width=1.4\textwidth]{Secret Raffle Monorepo Frontend Structure Diagram.png}
%   \caption{Frontend Architecture Structure Diagram.}
%   \label{fig:Frontend Architecture Structure Diagram Appendix}
% \end{figure}

% \begin{table}[h]
%   \centering
%   \caption{State Layout}
%   \begin{tabular}{@{}lll@{}}
%     \toprule
%     \textbf{Key} & \textbf{Type} & \textbf{Purpose} \\
%     \midrule
%     \texttt{ADMIN} & \texttt{Item<CanonicalAddr>} & Contract admin \\
%     \texttt{RAFFLE} & \texttt{Item<Raffle>} & Config: end time, price, secret \\
%     \texttt{TICKETS} & \texttt{Keymap<CanonicalAddr,u64>} & User ticket balances \\
%     \texttt{TOTAL\_TICKETS} & \texttt{Item<u64>} & Total tickets sold \\
%     \texttt{WINNER} & \texttt{Item<Option<CanonicalAddr>>} & Selected winner \\
%     \texttt{RAFFLE\_STARTED} & \texttt{Item<bool>} & Raffle status \\
%     \texttt{WINNER\_SELECTED} & \texttt{Item<bool>} & Winner selection status \\
%     \texttt{PRIZE\_CLAIMED} & \texttt{Item<bool>} & Prize claim status \\
%     \bottomrule
%   \end{tabular}
% \end{table}

\end{document}
